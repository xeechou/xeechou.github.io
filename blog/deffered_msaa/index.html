
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Realistic Deferred MSAA implementation</title>

    <meta name="HandheldFriendly" content="true" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    
    <link rel="stylesheet" href="/css/style.min.16ff99eb19bcfa54bac497af8e22276ea7e749db09c93ea0fa98f658ad68017a.css" integrity="sha256-Fv&#43;Z6xm8&#43;lS6xJevjiInbqfnSdsJyT6g&#43;pj2WK1oAXo=" />
    
    
      
    
  </head>
  <body class="post-template">
    

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>
      
      
        <li class="nav-about-me" role="presentation">
          <a href="/about/">About Me</a>
        </li>
      
      
      
    </ul>
  </div>
</nav>


    <section id="wrapper">
      <a class="hidden-close"></a>

      

<div class="progress-container">
  <span class="progress-bar"></span>
</div>



<header id="post-header" class="has-cover">
  <div class="inner">
    
<nav id="navigation">
  
    
      <span id="home-button" class="nav-button">
        <a class="home-button" href="https://xeechou.net/" title="Home">
          <i class="ic ic-arrow-left"></i> Home
        </a>
      </span>
    
  
  
  <span id="menu-button" class="nav-button">
    <a class="menu-button">
      <i class="ic ic-menu"></i>
      Menu
    </a>
  </span>
  
</nav>

    <h1 class="post-title">Realistic Deferred MSAA implementation</h1>
    <span class="post-meta">
      
      <time datetime="2018-12-03">03 Dec 2018</time>
    </span>

    
      <div class="post-cover cover" style="background-image: url('https://xeechou.net/imgs/post-bg.jpg');"></div>
    
  </div>
</header>

<main class="content" role="main">
  <article class="post">
    <div class="inner">
      <section class="post-content"><p>Deferred MSAA, always has been a good problem. In the spatial anti-aliasing
domain, MSAA is still the swiss-army knife, handle almost all the case.</p>
<p>Some other post-processing methods like nvidia&rsquo;s FXAA, AMDs MLAA, or DLAA. FXAA
is rather pleasing in many cases as well, especially if
you are a video game developer, as long as your rasterization implementation
does not screwed up. But for the case like grass rendering, fur rendering, when
you have many layers of thin line, FXAA will fail you. Just like the pixels
annotated in the image below.</p>
<p><img src="/imgs/fxaa-issue.png" alt="FXAA-issue"></p>
<!-- raw HTML omitted -->
<p>Other option like Nvidia&rsquo;s AGAA(aggregated G-buffer anti-aliasing) Or if you are
really a game developer, TAA maybe the way to go. But here we are talking about
good old MSAA technique(also, refer to this
<a href="https://mynameismjp.wordpress.com/2010/08/16/deferred-msaa/">article</a> if you
can have non-even sample depth buffer). Here we are talking about MSAA, with
only OpenGL 4.0 capability, no special vendor requirement. The trick is simple
and effective: &ldquo;MSAA edge detection&rdquo;. If we can detect difference between simple
pixel and complex pixel, we can treat them differently. It is the similar idea
from <a href="https://docs.nvidia.com/gameworks/content/gameworkslibrary/graphicssamples/d3d_samples/antialiaseddeferredrendering.htm">this
method</a>.
In the D3D API, you can use <code>SV_Coverage</code>, in GLSL, you have similar variable
<code>GL_SampleMaskIn</code>, these are the variable which are available in the pixel
shader, tell the GPU which sample to write after shading. Take <code>4xMSAA</code> for
example, if all the samples come from the same fragment, then the sample mask is
<code>1111</code> for that pixel(4 bits). If the fragment only writes to 2 samples, the
sample mask would be <code>1010</code>, <code>1100</code> <code>0011</code>, <code>0101</code>, etc. Which in turns mark
this pixel complex.</p>
<p><img src="/imgs/complex-pixels.png" alt="complex pixels"></p>
<!-- raw HTML omitted -->
<p>There is only one problem here. Through my experiement with opengl, if the pixel
is not on the triangles edge, but on the intersection of two triangles, the
sample mask does not reflect this problem. I guess that is why when you look the
came at the ground in the video game, there is still aliasing effect at the
intersection of grass and terrian. To solve this, you can apply apply a normal
test on the samples, if the pixel locates on the intersection, the normal test
fails and thus mark the pixel complex.</p>
<p>Voil√†, here is your deffered MSAA, it runs really fast for the lighting pass,
and it works all the time, unless(there is always an exception), you have
co-planar z-fighting problem, then you would have probably bigger problem to
worry about than anti-aliasing.</p>
</section>

      <section class="post-info">
	


<div class="post-share">

  
  <a class="twitter" href="https://twitter.com/share?url=https://xeechou.net/blog/deffered_msaa/&amp;text=Realistic%20Deferred%20MSAA%20implementation" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
  </a>

  
  <a class="facebook" href="https://www.facebook.com/sharer.php?u=https://xeechou.net/blog/deffered_msaa/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
    <i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
  </a>

  
  <a class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://xeechou.net/blog/deffered_msaa/&amp;title=Realistic%20Deferred%20MSAA%20implementation" onclick="window.open(this.href, 'linkedin-share', 'width=490,height=530');return false;">
    <i class="ic ic-linkedin"></i><span class="hidden">linkedin</span>
  </a>

  
  <a class="reddit" href="http://www.reddit.com/submit?url=https://xeechou.net/blog/deffered_msaa/&amp;title=Realistic%20Deferred%20MSAA%20implementation" onclick="window.open(this.href, 'reddit-share', width=580,height=500);return false;">
    <i class="ic ic-reddit"></i><span class="hidden">reddit</span>
  </a>

  <div class="clear"></div>
</div>

        <aside class="post-tags">
          
            
            <a href="https://xeechou.net/tags/graphics">graphics</a>
          
        </aside>

        <div class="clear"></div>
      </section>

      

      
      
      <section class="post-comments activated">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "insature" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </section>
      

      <aside class="post-nav">
        
          <a class="post-nav-next" href="https://xeechou.net/blog/the_wayland_project_2/">
            <section class="post-nav-teaser">
              <i class="ic ic-arrow-left"></i>
              <h2 class="post-nav-title">The wayland project II</h2>
              <p class="post-nav-excerpt">The last post I laid out the story of me with wayland. Technology is fascinating isn&rsquo;t it? Every once a while, there are plenty of new projects that aim to start an revolution, getting people excited. Projects like systemd, Wayland, Vulkan make us think how come we did not think of those before, they seemed perfect at the moment. Technologies always work like a rush of hot wave, our sights are limited at the moment we are in, maybe 5 years from now, even vulkan is not sexy anymore.</p>
            </section>
          </a>
        
        
          <a class="post-nav-prev" href="https://xeechou.net/blog/busy-in-quarantine/">
            <section class="post-nav-teaser">
              <i class="ic ic-arrow-right"></i>
              <h2 class="post-nav-title">Busy in quarantine</h2>
              <p class="post-nav-excerpt">I update this blog less frequent than once per year, which sometimes makes me question why do I keep paying for this site. Be able to update blogs is always my pursuit, unfortunately there were always more code to write. It has been more than one year, last time I was still on how to MSAA on OpenGL 4, somehow it felt like a decade ago. The peaceful developing world took an interesting turn.</p>
            </section>
          </a>
        
        <div class="clear"></div>
      </aside>
    </div>
  </article>
</main>



            <footer id="footer">
        <div class="inner">
          <section class="credits">
            <span class="credits-theme">
              
              
              Theme <a href="https://github.com/zutrinken/attila">Attila</a> by <a href="https://zutrinken.com" rel="nofollow">zutrinken</a>
              |
              
              
              Theme <a href="https://github.com/xeechou/hugo-theme-attila">hugo-theme-attila</a> by <a href="https://xeechou.net" rel="nofollow">xeechou</a>
            </span>
            <span class="credits-software">
              
              Published with <a href="https://gohugo.io">Hugo</a>
            </span>
          </section>
        </div>
      </footer>

    </section>

    
    
    
    
    
    
    
    <script src="/js/script.js"></script>

    
      
    
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-119901699-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
